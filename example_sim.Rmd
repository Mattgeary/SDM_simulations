Simulating Epidemiological distribution models
========================================================

We'll need the following packages for these simulations.

```{r}
library(maptools)
library(sp)
library(raster)
library(dismo)
library(rgdal)
```


First we load data for the african continent and environmental variables from WORLDCLIM. These are cropped to cover our region of interest


```{r}
# Read in continental outline
africa.shp <- readShapeSpatial("africa.shp", proj4string=CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"))
kenya <- getData('GADM', country='KEN', level=0)
                               
# Read in global data
global.mean.temp <- getData('worldclim', var='tmean', res=10)
global.min.temp <- getData('worldclim', var='tmin', res=10)
global.max.temp <- getData('worldclim', var='tmax', res=10)
global.bio <- getData('worldclim', var='bio', res=10) 
global.precip <-getData('worldclim', var='prec', res=10)
global.alt <- getData('worldclim', var='alt', res=10)

# Crop to africa extent
africa.mean.temp <-  crop(global.mean.temp, extent(africa.shp))
africa.min.temp <-  crop(global.min.temp, extent(africa.shp))
africa.max.temp <-  crop(global.max.temp, extent(africa.shp))
africa.bio <-  crop(global.bio, extent(africa.shp))
africa.precip <-  crop(global.precip, extent(africa.shp))
africa.alt <- crop(global.alt, extent(africa.shp))

# Find mean values for temperature and precipitation
mean.temp.yr <- mean(africa.mean.temp)
min.temp.yr <- max(africa.max.temp)
max.temp.yr <- min(africa.min.temp)
precip.yr <- mean(africa.precip)
```

Plot these data

```{r fig.width=7, fig.height=6}
plot(mean.temp.yr)
```
```{r fig.width=7, fig.height=6}
plot(max.temp.yr)
```
```{r fig.width=7, fig.height=6}
plot(min.temp.yr)
```
```{r fig.width=7, fig.height=6}
plot(precip.yr)
```
```{r fig.width=7, fig.height=6}
plot(africa.alt)
```

Now we reclass the bioclimatic maps to find areas which fit into a pre-determined threshold.
As an example we'll use:

* Between 506m and 993m asl
* Mean temperature between 23.9 and 26.5 degrees C
* Precipitation above 10

To do this we'll reclass the three maps and combine them to find the suitable and unsuitable areas in a binary map

```{r}
rcl <- matrix(c(0, 238.999,0, 238.9999, 265, 1, 256.0001, 315,0), nrow=3, ncol=3, byrow=T)
bin.mean.temp <- reclassify(mean.temp.yr, rcl)

rcl <- matrix(c(-354, 505.999, 0, 505.9999, 993, 1, 993.0001, 3884,0), nrow=3, ncol=3, byrow=T)
bin.alt <- reclassify(africa.alt, rcl)

rcl <- matrix(c(0, 9.999, 0,9.9999, 365, 1), nrow=2, ncol=3, byrow=T)
bin.precip <- reclassify(precip.yr, rcl)

rcl <- matrix(c(0, 2.999, 0,2.9999, 3, 1), nrow=2, ncol=3, byrow=T)
bin.suit <- reclassify((bin.mean.temp+bin.alt+bin.precip), rcl)
```

Plot the suitable area

```{r fig.width=7, fig.height=6}
plot(bin.suit)
```

We can now take random points from the extent of Africa to be our presence and absence points for the model of suitability across Africa usinf the randomPoints() funtion in dismo. We can then extract the values of the predictor variables for these points.

```{r}
africa.pres <- randomPoints(bin.suit, 500)

africa.data <- data.frame(presence = numeric(500),mean.temp.yr = numeric(500), min.temp.yr=numeric(500),max.temp.yr=numeric(500),precip.yr = numeric(500), africa.alt=numeric(500))

africa.data$presence <- extract(bin.suit, africa.pres)
africa.data$mean.temp.yr <- extract(mean.temp.yr, africa.pres)
africa.data$max.temp.yr <- extract(max.temp.yr, africa.pres)
africa.data$min.temp.yr <- extract(min.temp.yr, africa.pres)
africa.data$precip.yr <- extract(precip.yr, africa.pres)
africa.data$africa.alt <- extract(africa.alt, africa.pres)
```

Now weed need a subset of the environmental variables to simulated a sampling excercise with limited geogrpahic area. We will use Kenya as our sampling area.

```{r}
# Crop to Kenya extent
kenya.mean.temp <-  crop(mean.temp.yr, extent(kenya))
#kenya.min.temp <-  crop(min.temp.yr, extent(kenya))
#kenya.max.temp <-  crop(max.temp.yr, extent(kenya))
#kenya.bio <-  crop(africa.bio, extent(kenya))
kenya.precip <-  crop(precip.yr, extent(kenya))
kenya.alt <- crop(africa.alt, extent(kenya))

# Crop binary suitability map to Kenya extent
kenya.bin <- crop(bin.suit, extent(kenya))

# Take samples from kenya

kenya.points <- randomPoints(kenya.bin, 500)
kenya.pres<- cbind(kenya.points, pa = extract(kenya.bin, kenya.points))
kenya.pres <- as.data.frame(kenya.pres)
ab <- which(kenya.pres$pa == 0)
kenya.pres <- kenya.pres[-c(sample(ab, length(ab)*0.6)),]
rm(ab)

```
Let's take a quick look at our fieldwork...
```{r fig.width=7, fig.height=6}
plot(kenya.bin, main="Distribution of disease in Kenya", colNA="blue")
symb <- kenya.pres$pa
symb[which(symb == 1)] <- 16 
symb[which(symb == 0)] <- 1 
points(points(kenya.pres$x, kenya.pres$y, pch=symb))
```

Extract environmental variables from presence/absence points
```{r}

kenya.data <- data.frame(presence = numeric(length(kenya.pres$pa)),mean.temp.yr = numeric(length(kenya.pres$pa)), min.temp.yr=numeric(length(kenya.pres$pa)),max.temp.yr=numeric(length(kenya.pres$pa)),precip.yr = numeric(length(kenya.pres$pa)), africa.alt=numeric(length(kenya.pres$pa)))

kenya.data$presence <- kenya.pres$pa
kenya.data$mean.temp.yr <- extract(mean.temp.yr, kenya.pres[,1:2])
kenya.data$max.temp.yr <- extract(max.temp.yr, kenya.pres[,1:2])
kenya.data$min.temp.yr <- extract(min.temp.yr, kenya.pres[,1:2])
kenya.data$precip.yr <- extract(precip.yr, kenya.pres[,1:2])
kenya.data$africa.alt <- extract(africa.alt, kenya.pres[,1:2])
```

Models
```{r}
mod.1 <- glm(presence ~ mean.temp.yr + alt, data=kenya.data, family="binomial")
mod.2 <- glm(presence ~ precip.yr + alt, data=kenya.data, family="binomial")
mod.3 <- glm(presence ~ precip.yr * alt, data=kenya.data, family="binomial")
mod.4<- glm(presence ~ mean.temp.yr * alt, data=kenya.data, family="binomial")

```

To predict the distribution across Kenya we need to convert the Kenyan environmental data to a data frame

```{r]}

# Create a dataframe for the raster data

kenya.env <- data.frame(mean.temp.yr=numeric(2688), precip.yr=numeric(2688),alt=numeric(2688))

kenya.env$mean.temp.yr <-values(kenya.mean.temp)
kenya.env$precip.yr <- values(kenya.precip)
kenya.env$alt <-values(kenya.alt)

```

Plot the predicted values for Kenya

```{r}
pred <- predict(mod.4, kenya.env, type="response")
pred.map <- raster(matrix(pred, nrow=nrow(kenya.alt), ncol=ncol(kenya.alt), byrow=T), template=kenya.bin)

```
We can look at the the predicted presence of disease in kenya by plotting out predicted map. It might also be useful to convery our probability of presence to a binary presence/absence map and compare this to the presence/absence map we created using our threshold rules.

```{r fig.width=16, fig.height=8}
oldpar <- par(mfrow=c(1,3))
plot(pred.map, main="Predicted probability of presence")
pred.bin <- reclassify(pred.map, matrix(c(0,0.49,0,0.5,1,1), nrow=2, ncol=3, byrow=T))
plot(pred.bin, main="Predicted binary distribution")
plot(kenya.bin - pred.bin, main="Difference 'actual' and predicted distributions")
par(oldpar)
```{r]}

# Create a dataframe for the raster data

kenya.env <- data.frame(mean.temp.yr=numeric(2688), precip.yr=numeric(2688),alt=numeric(2688))

kenya.env$mean.temp.yr <-values(kenya.mean.temp)
kenya.env$precip.yr <- values(kenya.precip)
kenya.env$alt <-values(kenya.alt)

```